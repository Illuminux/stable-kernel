From 2428dfd595ed3d1d2600faeccb54ef29c2e3417b Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Fri, 25 Feb 2011 16:58:55 -0600
Subject: [PATCH 4/4] omap3: touchbook: tesing lcd display

Signed-off-by: Robert Nelson <robertcnelson@gmail.com>
---
 arch/arm/mach-omap2/board-omap3touchbook.c |   75 +++++++++++++++++++++-------
 1 files changed, 57 insertions(+), 18 deletions(-)

diff --git a/arch/arm/mach-omap2/board-omap3touchbook.c b/arch/arm/mach-omap2/board-omap3touchbook.c
index 593b491..b490dd1 100644
--- a/arch/arm/mach-omap2/board-omap3touchbook.c
+++ b/arch/arm/mach-omap2/board-omap3touchbook.c
@@ -45,6 +45,8 @@
 
 #include <plat/board.h>
 #include <plat/common.h>
+#include <plat/display.h>
+#include <plat/panel-generic-dpi.h>
 #include <plat/gpmc.h>
 #include <plat/nand.h>
 #include <plat/usb.h>
@@ -105,6 +107,55 @@ static struct omap_nand_platform_data omap3touchbook_nand_data = {
 
 #include "sdram-micron-mt46h32m32lf-6.h"
 
+static int touchbook_enable_lcd(struct omap_dss_device *dssdev)
+{
+	if (gpio_is_valid(dssdev->reset_gpio))
+		gpio_set_value_cansleep(dssdev->reset_gpio, 1);
+	return 0;
+}
+
+static void touchbook_disable_lcd(struct omap_dss_device *dssdev)
+{
+	if (gpio_is_valid(dssdev->reset_gpio))
+		gpio_set_value_cansleep(dssdev->reset_gpio, 0);
+}
+
+static struct panel_generic_dpi_data lcd_panel = {
+	.name			= "generic",
+	.platform_enable        = touchbook_enable_lcd,
+	.platform_disable       = touchbook_disable_lcd,
+};
+
+static struct omap_dss_device touchbook_lcd_device = {
+	.name					= "lcd",
+	.type                   = OMAP_DISPLAY_TYPE_DPI,
+	.driver_name            = "generic_dpi_panel",
+	.data					= &lcd_panel,
+	.phy.dpi.data_lines     = 24,
+	.reset_gpio = 176,
+};
+
+static struct omap_dss_device *touchbook_dss_devices[] = {
+	&touchbook_lcd_device,
+};
+
+static struct omap_dss_board_info touchbook_dss_data = {
+	.num_devices = ARRAY_SIZE(touchbook_dss_devices),
+	.devices = touchbook_dss_devices,
+	.default_device = &touchbook_lcd_device,
+};
+
+static struct platform_device touchbook_dss_device = {
+	.name		= "omapdss",
+	.id		= -1,
+	.dev            = {
+		.platform_data = &touchbook_dss_data,
+	},
+};
+
+static struct regulator_consumer_supply touchbook_vdda_dac_supply =
+	REGULATOR_SUPPLY("vdda_dac", "omap_venc");
+
 static struct omap2_hsmmc_info mmc[] = {
 	{
 		.mmc		= 1,
@@ -114,11 +165,6 @@ static struct omap2_hsmmc_info mmc[] = {
 	{}	/* Terminator */
 };
 
-static struct platform_device omap3_touchbook_lcd_device = {
-	.name		= "omap3touchbook_lcd",
-	.id		= -1,
-};
-
 static struct omap_lcd_config omap3_touchbook_lcd_config __initdata = {
 	.ctrl_name	= "internal",
 };
@@ -172,16 +218,6 @@ static struct twl4030_gpio_platform_data touchbook_gpio_data = {
 	.setup		= touchbook_twl_gpio_setup,
 };
 
-static struct regulator_consumer_supply touchbook_vdac_supply = {
-	.supply		= "vdac",
-	.dev		= &omap3_touchbook_lcd_device.dev,
-};
-
-static struct regulator_consumer_supply touchbook_vdvi_supply = {
-	.supply		= "vdvi",
-	.dev		= &omap3_touchbook_lcd_device.dev,
-};
-
 /* VMMC1 for MMC1 pins CMD, CLK, DAT0..DAT3 (20 mA, plus card == max 220 mA) */
 static struct regulator_init_data touchbook_vmmc1 = {
 	.constraints = {
@@ -223,7 +259,7 @@ static struct regulator_init_data touchbook_vdac = {
 					| REGULATOR_CHANGE_STATUS,
 	},
 	.num_consumer_supplies	= 1,
-	.consumer_supplies	= &touchbook_vdac_supply,
+	.consumer_supplies	= &touchbook_vdda_dac_supply,
 };
 
 /* VPLL2 for digital video outputs */
@@ -238,7 +274,7 @@ static struct regulator_init_data touchbook_vpll2 = {
 					| REGULATOR_CHANGE_STATUS,
 	},
 	.num_consumer_supplies	= 1,
-	.consumer_supplies	= &touchbook_vdvi_supply,
+	.consumer_supplies	= &touchbook_vdda_dac_supply,
 };
 
 static struct twl4030_usb_data touchbook_usb_data = {
@@ -423,9 +459,9 @@ static void __init omap3_touchbook_init_irq(void)
 }
 
 static struct platform_device *omap3_touchbook_devices[] __initdata = {
-	&omap3_touchbook_lcd_device,
 	&leds_gpio,
 	&keys_gpio,
+	&touchbook_dss_device,
 };
 
 static void __init omap3touchbook_flash_init(void)
@@ -526,6 +562,9 @@ static void __init omap3_touchbook_init(void)
 	/* Ensure SDRC pins are mux'd for self-refresh */
 	omap_mux_init_signal("sdrc_cke0", OMAP_PIN_OUTPUT);
 	omap_mux_init_signal("sdrc_cke1", OMAP_PIN_OUTPUT);
+
+	omap_display_init(&touchbook_dss_data);
+
 }
 
 MACHINE_START(TOUCHBOOK, "OMAP3 touchbook Board")
-- 
1.7.1

