From bf8f999f8b298167af25ef09f089fa2e20ebd0c1 Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Thu, 16 Sep 2010 16:11:30 -0500
Subject: [PATCH 22/22] ARM OMAP Touchbook upstream add accelerometer

---
 arch/arm/mach-omap2/board-omap3touchbook.c |  145 ++++++++++++++++++----------
 1 files changed, 92 insertions(+), 53 deletions(-)

diff --git a/arch/arm/mach-omap2/board-omap3touchbook.c b/arch/arm/mach-omap2/board-omap3touchbook.c
index 5fb972a..35135b2 100644
--- a/arch/arm/mach-omap2/board-omap3touchbook.c
+++ b/arch/arm/mach-omap2/board-omap3touchbook.c
@@ -33,7 +33,7 @@
 #include <linux/spi/spi.h>
 
 #include <linux/spi/ads7846.h>
-
+#include <linux/mma7455l.h>
 #include <linux/regulator/machine.h>
 #include <linux/i2c/twl.h>
 #include <linux/i2c/chacha.h>
@@ -393,49 +393,6 @@ static int __init touchbook_i2c_init(void)
 	return 0;
 }
 
-static struct ads7846_platform_data touchbook_ads7846_config = {
-	.x_min			= 100,
-	.y_min			= 265,
-	.x_max			= 3950,
-	.y_max			= 3750,
-	.x_plate_ohms		= 40,
-	.pressure_max		= 255,
-	.debounce_max		= 10,
-	.debounce_tol		= 5,
-	.debounce_rep		= 1,
-	.gpio_pendown		= 162,
-	.keep_vref_on		= 1,
-};
-
-static struct omap2_mcspi_device_config touchbook_ads7846_mcspi_config = {
-	.turbo_mode	= 0,
-	.single_channel	= 1,	/* 0: slave, 1: master */
-};
-
-static struct spi_board_info __initdata touchbook_spi_board_info[] = {
-	{
-		.modalias		= "ads7846",
-		.bus_num		= 4,
-		.chip_select		= 0,
-		.max_speed_hz		= 1500000,
-		.controller_data	= &touchbook_ads7846_mcspi_config,
-		.irq			= OMAP_GPIO_IRQ(162),
-		.platform_data		= &touchbook_ads7846_config,
-	}
-};
-
-static void __init touchbook_ads7846_init(void)
-{
-	int touchbook_ads7846_gpio = 162;
-	if (gpio_request(touchbook_ads7846_gpio, "ads7846_pen_down")) {
-		printk(KERN_ERR "Failed to request GPIO %d for ads7846 pen down IRQ\n", touchbook_ads7846_gpio);
-		return;
-	}
-
-	gpio_direction_input(touchbook_ads7846_gpio);
-	gpio_set_debounce(touchbook_ads7846_gpio, 310);
-}
-
 static struct gpio_led gpio_leds[] = {
 	{
 		.name			= "touchbook::usr0",
@@ -454,6 +411,7 @@ static struct gpio_led gpio_leds[] = {
 	},
 };
 
+
 static struct gpio_led_platform_data gpio_led_info = {
 	.leds		= gpio_leds,
 	.num_leds	= ARRAY_SIZE(gpio_leds),
@@ -495,14 +453,6 @@ static struct platform_device keys_gpio = {
 	},
 };
 
-#ifdef CONFIG_OMAP_MUX
-static struct omap_board_mux board_mux[] __initdata = {
-	{ .reg_offset = OMAP_MUX_TERMINATOR },
-};
-#else
-#define board_mux	NULL
-#endif
-
 static struct platform_device *omap3_touchbook_devices[] __initdata = {
 	&leds_gpio,
 	&keys_gpio,
@@ -554,6 +504,94 @@ static const struct ehci_hcd_omap_platform_data ehci_pdata __initconst = {
 	.reset_gpio_port[2]  = -EINVAL
 };
 
+#ifdef CONFIG_OMAP_MUX
+static struct omap_board_mux board_mux[] __initdata = {
+	{ .reg_offset = OMAP_MUX_TERMINATOR },
+};
+#else
+#define board_mux	NULL
+#endif
+
+static struct ads7846_platform_data touchbook_ads7846_config = {
+	.x_min			= 100,
+	.y_min			= 265,
+	.x_max			= 3950,
+	.y_max			= 3750,
+	.x_plate_ohms		= 40,
+	.pressure_max		= 255,
+	.debounce_max		= 10,
+	.debounce_tol		= 5,
+	.debounce_rep		= 1,
+	.gpio_pendown		= 162,
+	.keep_vref_on		= 1,
+};
+
+static struct omap2_mcspi_device_config touchbook_ads7846_mcspi_config = {
+	.turbo_mode	= 0,
+	.single_channel	= 1,	/* 0: slave, 1: master */
+};
+
+static struct spi_board_info __initdata touchbook_spi_board_info_4[] = {
+	{
+		.modalias		= "ads7846",
+		.bus_num		= 4,
+		.chip_select		= 0,
+		.max_speed_hz		= 1500000,
+		.controller_data	= &touchbook_ads7846_mcspi_config,
+		.irq			= OMAP_GPIO_IRQ(162),
+		.platform_data		= &touchbook_ads7846_config,
+	}
+};
+
+static void __init touchbook_ads7846_init(void)
+{
+	int touchbook_ads7846_gpio = 162;
+	if (gpio_request(touchbook_ads7846_gpio, "ads7846_pen_down")) {
+		printk(KERN_ERR "Failed to request GPIO %d for ads7846 pen down IRQ\n", touchbook_ads7846_gpio);
+		return;
+	}
+
+	gpio_direction_input(touchbook_ads7846_gpio);
+	gpio_set_debounce(touchbook_ads7846_gpio, 310);
+}
+
+static struct mma7455l_platform_data touchbook_mma7455l_config = {
+	.calibration_x = -4,
+	.calibration_y = 28,
+	.calibration_z = -28,
+};
+
+static struct omap2_mcspi_device_config touchbook_mma7455l_mcspi_config = {
+	.turbo_mode	= 0,
+	.single_channel	= 1,	/* 0: slave, 1: master */
+};
+
+static struct spi_board_info __initdata touchbook_spi_board_info_3[] = {
+	{
+		.modalias		= "mma7455l",
+		.bus_num		= 3,
+		.chip_select		= 0,
+		.max_speed_hz		= 200000,
+		.irq			= OMAP_GPIO_IRQ(136),
+		.controller_data	= &touchbook_mma7455l_mcspi_config,
+		.platform_data		= &touchbook_mma7455l_config,
+	}
+};
+
+static void __init touchbook_mma7455l_init(void)
+{
+	int ret;
+	int touchbook_mma7455l_gpio = 136;
+
+	ret = gpio_request(touchbook_mma7455l_gpio, "mma7455l");
+	if (ret < 0) {
+		printk(KERN_ERR "Failed to request GPIO %d for mma7455l IRQ\n", touchbook_mma7455l_gpio);
+		return;
+	}
+
+	gpio_direction_input(touchbook_mma7455l_gpio);
+}
+
 static void omap3_touchbook_poweroff(void)
 {
 	int r;
@@ -608,7 +646,8 @@ static void __init touchbook_init(void)
 	touchbook_display_init();
 
 	/* Touchscreen and accelerometer */
-	spi_register_board_info(touchbook_spi_board_info, ARRAY_SIZE(touchbook_spi_board_info));
+	spi_register_board_info(touchbook_spi_board_info_4, ARRAY_SIZE(touchbook_spi_board_info_4));
+	spi_register_board_info(touchbook_spi_board_info_3, ARRAY_SIZE(touchbook_spi_board_info_3));
 	touchbook_ads7846_init();
 }
 
-- 
1.7.1

